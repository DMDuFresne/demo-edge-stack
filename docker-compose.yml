# ==============================================================================
# SHARED CONFIGURATION TEMPLATES
# ==============================================================================

# Common logging configuration for all services
x-common: &common
  logging:
    driver: json-file
    options:
      max-size: '10m'
      max-file: '3'

# Resource templates for edge deployment optimization
x-resources-xlarge: &resources-xlarge
  deploy:
    resources:
      limits: { cpus: '4', memory: 4G }
      reservations: { cpus: '2', memory: 2G }

x-resources-large: &resources-large
  deploy:
    resources:
      limits: { cpus: '2', memory: 2G }
      reservations: { cpus: '1', memory: 1G }

x-resources-medium: &resources-medium
  deploy:
    resources:
      limits: { cpus: '1', memory: 1G }
      reservations: { cpus: '0.5', memory: 512M }

x-resources-small: &resources-small
  deploy:
    resources:
      limits: { cpus: '0.5', memory: 512M }
      reservations: { cpus: '0.25', memory: 256M }

x-resources-tiny: &resources-tiny
  deploy:
    resources:
      limits: { cpus: '0.25', memory: 256M }
      reservations: { cpus: '0.1', memory: 128M }

# ==============================================================================
# SERVICES
# ==============================================================================

services:

  # ----------------------------------------------------------------------------
  # SCADA & HMI
  # ----------------------------------------------------------------------------

  ignition:
    <<: [*common, *resources-xlarge]
    image: inductiveautomation/ignition:${IGNITION_TAG:-8.3.0}
    container_name: mes-ignition-gateway
    hostname: mes-ignition-gateway
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${IGNITION_HTTP_PORT:-8088}:8088"    # HTTP
      - "${IGNITION_HTTPS_PORT:-8043}:8043"   # HTTPS
      - "${IGNITION_GAN_PORT:-8060}:8060"     # Gateway Network
    environment:
      ACCEPT_IGNITION_EULA: Y
      TZ: ${TZ:-America/Chicago}
      GATEWAY_ADMIN_USERNAME: ${GATEWAY_ADMIN_USERNAME:-admin}
      GATEWAY_ADMIN_PASSWORD: ${IGNITION_PASSWORD}
      IGNITION_EDITION: ${IGNITION_EDITION:-standard}
      GATEWAY_MODULES_ENABLED: ${GATEWAY_MODULES_ENABLED}
      IGNITION_LICENSE_KEY: ${IGNITION_LICENSE_KEY}
      IGNITION_ACTIVATION_TOKEN: ${IGNITION_ACTIVATION_TOKEN}
      DISABLE_QUICKSTART: ${DISABLE_QUICKSTART:-false}
      IGNITION_UID: ${IGNITION_UID:-2003}
      IGNITION_GID: ${IGNITION_GID:-2003}
    volumes:
      - ignition-data:/usr/local/bin/ignition/data
      - ./backups/ignition:/backup:ro
    command: >
      -n ${GATEWAY_NAME:-docker-dev-gateway}
      -m ${GATEWAY_MAX_MEMORY:-2048}
      --
      wrapper.java.initmemory=${GATEWAY_INIT_MEMORY:-512}
      wrapper.java.additional.1=-Dignition.allowunsignedmodules=${ALLOW_UNSIGNED_MODULES:-true}
      wrapper.java.additional.2=-Djava.awt.headless=true
      wrapper.java.additional.3=-Dfile.encoding=UTF-8

  # ----------------------------------------------------------------------------
  # MESSAGE BROKER
  # ----------------------------------------------------------------------------

  solace:
    <<: [*common, *resources-large]
    image: solace/solace-pubsub-standard:${SOLACE_TAG:-latest}
    container_name: mes-solace-broker
    hostname: mes-solace-broker
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${SOLACE_MANAGER_PORT:-8080}:8080"    # PubSub+ Manager / SEMP
      - "${SOLACE_SMF_PORT:-55555}:55555"      # SMF messaging
      - "${SOLACE_MQTT_PORT:-1883}:1883"       # MQTT
      - "${SOLACE_MQTT_WS_PORT:-8000}:8000"    # MQTT over WebSocket
      - "${SOLACE_AMQP_PORT:-5672}:5672"       # AMQP
      - "${SOLACE_REST_PORT:-9000}:9000"       # REST
      - "${SOLACE_SSH_PORT:-2222}:2222"        # SSH CLI
    shm_size: 1g
    ulimits:
      core: -1
      nofile: { soft: 2448, hard: 1048576 }
    environment:
      username_admin_globalaccesslevel: admin
      username_admin_password: ${SOLACE_ADMIN_PASSWORD:-admin}
      system_scaling_maxconnectioncount: ${SOLACE_MAX_CONNECTIONS:-100}
    volumes:
      - solace-data:/var/lib/solace
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ----------------------------------------------------------------------------
  # DATABASE & API
  # ----------------------------------------------------------------------------

  timescaledb:
    <<: [*common, *resources-xlarge]
    image: timescale/timescaledb:${TIMESCALEDB_TAG:-latest-pg17}
    container_name: mes-database
    hostname: mes-database
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${POSTGRES_EXTERNAL_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: mes
      LANG: en_US.utf8
      LC_ALL: en_US.utf8
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
      - ./database/creation:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d mes -h mes-database"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgraphile:
    <<: [*common, *resources-medium]
    image: graphile/postgraphile:${POSTGRAPHILE_TAG:-4}
    container_name: mes-postgraphile
    hostname: mes-postgraphile
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${POSTGRAPHILE_PORT:-5433}:5433"
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@mes-database:5432/mes
    command:
      - --connection
      - postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@mes-database:5432/mes
      - --schema
      - mes_core,mes_custom,mes_audit
      - --host
      - 0.0.0.0
      - --port
      - "5433"
      - --enhance-graphiql
      - --dynamic-json
      - --no-setof-functions-contain-nulls
      - --no-ignore-rbac
      - --no-ignore-indexes
      - --show-error-stack=json
      - --extended-errors
      - hint,detail,errcode
      - --retry-on-init-fail
      - --legacy-relations
      - omit
      - --cors
      - --graphql
      - /graphql
      - --graphiql
      - /graphiql
    depends_on:
      timescaledb: { condition: service_healthy }
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5433/graphql || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  pgadmin:
    <<: [*common, *resources-small]
    image: dpage/pgadmin4:${PGADMIN_TAG:-latest}
    container_name: mes-pgadmin
    hostname: mes-pgadmin
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      timescaledb: { condition: service_healthy }

  # ----------------------------------------------------------------------------
  # HISTORIAN (Timebase)
  # ----------------------------------------------------------------------------

  timebase-historian:
    <<: [*common, *resources-large]
    image: timebase/historian:${HISTORIAN_TAG:-latest}
    container_name: mes-historian
    hostname: mes-historian
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${HISTORIAN_PORT:-4511}:4511"
    environment:
      Settings: /historian/settings
      Data: /historian/data
      Logs: /historian/logs
    volumes:
      - historian-data:/historian

  timebase-collector:
    <<: [*common, *resources-medium]
    image: timebase/collector:${COLLECTOR_TAG:-latest}
    container_name: mes-historian-collector
    hostname: mes-historian-collector
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${COLLECTOR_PORT:-4521}:4521"
    environment:
      Active: false
      Settings: /collector/settings
      Config: /collector/config
      Data: /collector/data
      Logs: /collector/logs
    volumes:
      - collector-data:/collector
    depends_on:
      timebase-historian: { condition: service_started }

  timebase-explorer:
    <<: [*common, *resources-small]
    image: timebase/explorer:${EXPLORER_TAG:-latest}
    container_name: mes-historian-explorer
    hostname: mes-historian-explorer
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${EXPLORER_PORT:-4531}:4531"
    environment:
      Settings: /explorer/settings
      Config: /explorer/config
      Data: /explorer/data
      Logs: /explorer/logs
    volumes:
      - explorer-data:/explorer
    depends_on:
      timebase-historian: { condition: service_started }

  # ----------------------------------------------------------------------------
  # OPERATIONS & UTILITIES
  # ----------------------------------------------------------------------------

  db-backup:
    <<: [*common, *resources-tiny]
    image: prodrigestivill/postgres-backup-local:${BACKUP_TAG:-17}
    container_name: mes-database-backup
    hostname: mes-database-backup
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${BACKUP_HEALTHCHECK_PORT:-8888}:8888"
    environment:
      TZ: ${TZ}
      POSTGRES_HOST: mes-database
      POSTGRES_DB: mes
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SCHEDULE: "@daily"
      BACKUP_ON_START: true
      BACKUP_KEEP_DAYS: ${BACKUP_RETENTION_DAYS}
      BACKUP_ENCRYPTION_KEY: ${BACKUP_ENCRYPTION_KEY}
      HEALTHCHECK_PORT: 8888
      VALIDATE_ON_START: true
    volumes:
      - ./backups/database:/backups
    depends_on:
      timescaledb: { condition: service_healthy }
    healthcheck:
      test: ["CMD", "curl", "-s", "http://localhost:8888"]
      interval: 30s
      timeout: 10s
      retries: 3

  watchtower:
    <<: [*common, *resources-tiny]
    image: containrrr/watchtower:${WATCHTOWER_TAG:-latest}
    container_name: mes-watchtower
    hostname: mes-watchtower
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${WATCHTOWER_PORT:-8070}:8080"
    environment:
      WATCHTOWER_MONITOR_ONLY: true
      WATCHTOWER_CLEANUP: true
      WATCHTOWER_INCLUDE_STOPPED: true
      WATCHTOWER_REVIVE_STOPPED: false
      WATCHTOWER_LABEL_ENABLE: false
      WATCHTOWER_HTTP_API_TOKEN: ${WATCHTOWER_API_TOKEN}
      WATCHTOWER_HTTP_API_UPDATE: false
      WATCHTOWER_HTTP_API_METRICS: true
      WATCHTOWER_HTTP_API_PERIODIC_POLLS: true
      WATCHTOWER_DEBUG: false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ----------------------------------------------------------------------------
  # MONITORING & DASHBOARDS
  # ----------------------------------------------------------------------------

  homepage:
    <<: [*common, *resources-tiny]
    image: ghcr.io/gethomepage/homepage:${HOMEPAGE_TAG:-latest}
    container_name: mes-homepage
    hostname: mes-homepage
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${HOMEPAGE_PORT:-3000}:3000"
    environment:
      TZ: ${TZ:-America/Chicago}
      LOG_LEVEL: debug
    volumes:
      - ./config/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock

  glances:
    <<: [*common, *resources-tiny]
    image: nicolargo/glances:${GLANCES_TAG:-latest-full}
    container_name: mes-glances
    hostname: mes-glances
    restart: unless-stopped
    networks: [abelara-mes-network]
    ports:
      - "${GLANCES_PORT:-61208}:61208"
    environment:
      TZ: ${TZ:-America/Chicago}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/glances/glances.conf:/glances/conf/glances.conf:ro
      - ./config/glances/start.sh:/start.sh:ro
    command: ["/bin/sh", "/start.sh"]
    depends_on:
      solace: { condition: service_healthy }

# ==============================================================================
# NETWORKS
# ==============================================================================

networks:
  abelara-mes-network:
    name: ${NETWORK_NAME:-abelara-mes-network}
    driver: bridge

# ==============================================================================
# VOLUMES
# ==============================================================================

volumes:
  timescaledb-data:
    name: ${TIMESCALEDB_VOLUME_NAME:-timescaledb-data}
    labels:
      com.abelara.mes.volume.type: data
      com.abelara.mes.service: database

  ignition-data:
    name: ${IGNITION_VOLUME_NAME:-ignition-data}
    labels:
      com.abelara.mes.volume.type: data
      com.abelara.mes.service: ignition

  solace-data:
    name: ${SOLACE_VOLUME_NAME:-solace-data}
    labels:
      com.abelara.mes.volume.type: data
      com.abelara.mes.service: message-broker

  pgadmin-data:
    name: ${PGADMIN_VOLUME_NAME:-pgadmin-data}
    labels:
      com.abelara.mes.volume.type: data
      com.abelara.mes.service: pgadmin

  historian-data:
    name: ${HISTORIAN_VOLUME_NAME:-historian-data}
    labels:
      com.abelara.mes.volume.type: data
      com.abelara.mes.service: historian

  collector-data:
    name: ${COLLECTOR_VOLUME_NAME:-collector-data}
    labels:
      com.abelara.mes.volume.type: data
      com.abelara.mes.service: collector

  explorer-data:
    name: ${EXPLORER_VOLUME_NAME:-explorer-data}
    labels:
      com.abelara.mes.volume.type: data
      com.abelara.mes.service: explorer
